<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Mirror-Mirror</title>
	<link href="node_modules/bootswatch/darkly/bootstrap.min.css" type="text/css" rel="stylesheet" />
	<link href="assets/css/styles.css" type="text/css" rel="stylesheet" />
</head>
<body>
	<div class="container-fluid" ng-app="hudApp">
		<div class="page-header"></div>
        <div class="row">
            <div ng-controller="clockController" class="col-md-11 col-md-offset-1" id="dateTime">{{clock.dateTime}}</div>
        </div>
        <div class="row">
            <div ng-controller="clockController" class="col-md-7">
                <div class="col-md-3 col-md-offset-1" id="clock">{{clock.hoursAndMinutes}}</div>
                <div class="col-md-3" id="clockSeconds">{{clock.seconds}}</div>
            </div>
            <div ng-controller="currentWeatherController" id="currentWeather" class="col-md-4 col-md-offset-1">
                <div class="col-md-3">
                    <img id="currentWeatherIcon" class="largeImg" ng-src="assets/images/{{currentWeather.icon}}" alt="Weather Icon" />
                </div>
                <div id="currentWeatherTemperature" class="col-md-8">{{currentWeather.temperature}} &deg;</div>
            </div>
        </div>
        <!-- TODO: replace with an Angular component -->
        <div class="row">
            <div ng-controller="checklistController" class="col-md-6 col-md-offset-1"> <!-- Todo list starts -->
                <div class="row">&nbsp;</div>
                <div class="row">
                    <div class="col-md-6 checklistItem">List Item #1</div>
                    <div class="col-md-6 checklistItem">List Item #2</div>
                </div>
                <div class="row">
                    <div class="col-md-6 checklistItem">List Item #3</div>
                    <div class="col-md-6 checklistItem">List Item #4</div>
                </div>
                <div class="row">
                    <div class="col-md-6 checklistItem">List Item #5</div>
                    <div class="col-md-6 checklistItem">List Item #6</div>
                </div>
                <div class="row">
                    <div class="col-md-6 checklistItem">List Item #7</div>
                    <div class="col-md-6 checklistItem">List Item #8</div>
                </div>
                <div class="row">
                    <div class="col-md-6 checklistItem">List Item #9</div>
                    <div class="col-md-6 checklistItem">List Item #10</div>
                </div>
                <div class="row">
                    <div class="col-md-6 checklistItem">List Item #11</div>
                    <div class="col-md-6 checklistItem">List Item #12</div>
                </div>
            </div> <!-- Todo list ends -->
            <!-- TODO: replace with an Angular component -->
            <div ng-controller="forecastController" id="forecast" class="col-md-5"> <!-- Five Day weather starts -->
                <div class="row smallText">
                    <div id="day0" class="col-md-2 col-md-offset-2"></div>
                    <div class="col-md-2 imgHelper">
                        <img id="icon0" class="smallImg" src="" />
                    </div>
                    <div id="max0" class="col-md-2 text-right"></div>
                    <div id="min0" class="col-md-2 text-right"></div>
                </div>
                <div class="row smallText">
                    <div id="day1" class="col-md-2 col-md-offset-2"></div>
                    <div class="col-md-2 imgHelper">
                        <img id="icon1" class="smallImg" src="" />
                    </div>
                    <div id="max1" class="col-md-2 text-right"></div>
                    <div id="min1" class="col-md-2 text-right"></div>
                </div>
                <div class="row smallText">
                    <div id="day2" class="col-md-2 col-md-offset-2"></div>
                    <div class="col-md-2 imgHelper">
                        <img id="icon2" class="smallImg" src="" />
                    </div>
                    <div id="max2" class="col-md-2 text-right"></div>
                    <div id="min2" class="col-md-2 text-right"></div>
                </div>
                <div class="row smallText">
                    <div id="day3" class="col-md-2 col-md-offset-2"></div>
                    <div class="col-md-2 imgHelper">
                        <img id="icon3" class="smallImg" src="" />
                    </div>
                    <div id="max3" class="col-md-2 text-right"></div>
                    <div id="min3" class="col-md-2 text-right"></div>
                </div>
                <div class="row smallText">
                    <div id="day4" class="col-md-2 col-md-offset-2"></div>
                    <div class="col-md-2 imgHelper">
                        <img id="icon4" class="smallImg" src="" />
                    </div>
                    <div id="max4" class="col-md-2 text-right"></div>
                    <div id="min4" class="col-md-2 text-right"></div>
                </div>
            </div> <!-- Five Day weather ends -->
        </div>
    </div>
    <!--div>Icons made by <a href="http://www.flaticon.com/authors/google" title="Google">
        Google</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> 
        is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>-->
    
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/angular/angular.js"></script>
    <script src="node_modules/moment/min/moment.min.js"></script>
    <script src="assets/js/script.js"></script>

    <script>
        
        var WEATHER_ICON_LIST = [
            { id: DEFAULT_WEATHER_ID_DAY, icon: "2.svg", description: "default-day" },
            { id: DEFAULT_WEATHER_ID_NIGHT, icon: "3.svg", description: "default-night" },
            { id: 200, icon: "27.svg", description: "thunderstorm with light rain" },
            { id: 201, icon: "27.svg", description: "thunderstorm with rain" },
            { id: 202, icon: "27.svg", description: "thunderstorm with heavy rain" },
            { id: 210, icon: "27.svg", description: "light thunderstorm" },
            { id: 211, icon: "27.svg", description: "thunderstorm" },
            { id: 212, icon: "27.svg", description: "heavy thunderstorm" },
            { id: 221, icon: "27.svg", description: "ragged thunderstorm" },
            { id: 230, icon: "27.svg", description: "thunderstorm with light drizzle" },
            { id: 231, icon: "27.svg", description: "thunderstorm with drizzle" },
            { id: 232, icon: "27.svg", description: "thunderstorm with heavy drizzle" },
            { id: 300, icon: "17.svg", description: "light intensity drizzle" },
            { id: 301, icon: "17.svg", description: "drizzle" },
            { id: 302, icon: "17.svg", description: "heavy intensity drizzle" },
            { id: 310, icon: "17.svg", description: "light intensity drizzle rain" },
            { id: 311, icon: "17.svg", description: "drizzle rain" },
            { id: 312, icon: "17.svg", description: "heavy intensity drizzle rain" },
            { id: 313, icon: "17.svg", description: "shower rain and drizzle" },
            { id: 314, icon: "18.svg", description: "heavy shower rain and drizzle" },
            { id: 321, icon: "17.svg", description: "shower drizzle" },
            { id: 500, icon: "17.svg", description: "light rain" },
            { id: 501, icon: "17.svg", description: "moderate rain" },
            { id: 502, icon: "18.svg", description: "heavy intensity rain" },
            { id: 503, icon: "18.svg", description: "very heavy rain" },
            { id: 504, icon: "18.svg", description: "extreme rain" },
            { id: 511, icon: "18.svg", description: "freezing rain" },
            { id: 520, icon: "17.svg", description: "light intensity shower rain" },
            { id: 521, icon: "17.svg", description: "shower rain" },
            { id: 522, icon: "18.svg", description: "heavy intensity shower rain" },
            { id: 531, icon: "22.svg", description: "ragged shower rain" },
            { id: 600, icon: "22.svg", description: "light snow" },
            { id: 601, icon: "22.svg", description: "snow" },
            { id: 602, icon: "23.svg", description: "heavy snow" },
            { id: 611, icon: "22.svg", description: "sleet" },
            { id: 612, icon: "22.svg", description: "shower sleet" },
            { id: 615, icon: "22.svg", description: "light rain and snow" },
            { id: 616, icon: "22.svg", description: "rain and snow" },
            { id: 620, icon: "22.svg", description: "light shower snow" },
            { id: 621, icon: "22.svg", description: "shower snow" },
            { id: 622, icon: "23.svg", description: "heavy shower snow" },
            { id: 800, icon: "2.svg", description: "clear sky" },
            { id: 801, icon: "2.svg", description: "few clouds" },
            { id: 802, icon: "25.svg", description: "scattered clouds" },
            { id: 803, icon: "25.svg", description: "broken clouds" },
            { id: 804, icon: "25.svg", description: "overcast clouds" },
            { id: 905, icon: "6.svg", description: "windy" },
            { id: 906, icon: "24.svg", description: "hail" },
            { id: 951, icon: "2.svg", description: "calm" },
            { id: 741, icon: "13.svg", description: "fog" }
        ];
        var SUNRISE_TIME;
        var SUNSET_TIME;
        var DEFAULT_WEATHER_ID_DAY = 0;
        var DEFAULT_WEATHER_ID_NIGHT = 1;
        var WEATHER_TYPE_INDEX = 0;
        var WEATHER_COUNT_INDEX = 1;        
        var CITY_ID = "5074472"; // Omaha, NE
        var WEATHER_API_KEY = "";
        var HABITICA_USER_KEY = "";
        var HABITICA_API_KEY = "";
        var IMAGE_PATH = "assets/images/";
        var CURRENT_WEATHER_URL = "http://api.openweathermap.org/data/2.5/weather?id=" + CITY_ID + "&APPID=" + WEATHER_API_KEY + "&units=imperial";
        var FORECAST_WEATHER_URL = "http://api.openweathermap.org/data/2.5/forecast/city?id=" + CITY_ID + "&APPID=" + WEATHER_API_KEY + "&units=imperial";
        
        // Set timezone offset
        moment().utcOffset("-06:00"); // GMT -06:00
        
        // TODO: redo using Angular promises
        function getHabiticaTasks() {
            var tasks;
            
            $.ajax({
                async: false,
                url: 'https://habitica.com/api/v2/user/tasks',
                type: 'GET',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('x-api-user', HABITICA_USER_KEY);
                    xhr.setRequestHeader('x-api-key', HABITICA_API_KEY);
                },
                success: function(data) {
                    tasks = data;
                }
            });
            
            // TODO: parse the returned items looking for the todos
            console.log(tasks);
        }
        
        // Get the weather icon based on the id and the time of day
        function getWeatherIcon(id) {
            var defaultIconIndex = (isDayTime() ? DEFAULT_WEATHER_ID_DAY : DEFAULT_WEATHER_ID_NIGHT);
            var icon = WEATHER_ICON_LIST[defaultIconIndex].icon;
            var description = WEATHER_ICON_LIST[defaultIconIndex].description;
            
            $.each(WEATHER_ICON_LIST, function(key, value) {
                if(value.id == id) {
                    icon = value.icon;
                    description = value.description;
                    return false;
                }
            })
            
            return icon;
        }
        
        // Returns true if it is current day (time is between sunrise and sunset).
        // Also returns true if sunrise/sunset are unknown
        function isDayTime() {
            if(SUNRISE_TIME != undefined && SUNSET_TIME != undefined) {
                return (moment.utc() >= moment.utc(SUNRISE_TIME, "h:mm:ss A") 
                    && moment.utc() < moment.utc(SUNSET_TIME, "h:mm:ss A"));
            }            
            return true;
        }
        
        // TODO: redo using Angular promises
        function getSunriseSunsetTimes(latitude, longitude) {
            var sunriseSunsetUrl = "http://api.sunrise-sunset.org/json?lat=" + latitude + "&lng=" + longitude + "&date=today";
            var times;
            
            /*$.ajax({
                url: sunriseSunsetUrl,
                async: false,
                dataType: 'json',
                timeout: 5000,
                success: function(data) {
                    times = data;
                }
            });*/
            
            if(times != undefined && times.result != undefined) {
                sunriseTime = times.result.sunrise;
                sunsetTime = times.result.sunset;
            }
        }
        
        // TODO: redo using Angular promises
        function getforecastWeather() {
            if(WEATHER_API_KEY == "") {
                console.log("Weather API Key not set, exiting...");
                return false;
            }
            
            // Open Weather Map API: http://openweathermap.org/forecast5#5days
            var forecastWeather;            
    
            $.ajax({
                url: FORECAST_WEATHER_URL,
                async: false,
                dataType: 'json',
                success: function(data) {
                    forecastWeather = data;
                }
            });
            
            var forecasts = interpretForecastData(forecastWeather.list);
            
            for(var i = 0; i < 5; ++i) {                
                $('#day' + i).html(forecasts[i].dayText);
                $('#max' + i).html(forecasts[i].tempMax);
                $('#min' + i).html(forecasts[i].tempMin);
                $('#icon' + i).attr('src', IMAGE_PATH + forecasts[i].weatherIcon);
            }
            
            console.log('Forecasts: ');
            console.log(forecasts);
        }
        
        function interpretForecastData(forecastData) {
            var dateTimeFormat = "MM/DD/YYYY";
            var forecasts = [];
            var dayList = [];
            
            // Create the empty objects for each of the dates we need
            for(var i = 1; i <= 5; ++i) {
                var dateString = moment().add(i, 'days').format(dateTimeFormat);
                var value = {
                    "date": dateString,
                    "dayText": "",
                    "tempMinArr": [],
                    "tempMaxArr": [],
                    "tempMin": undefined,
                    "tempMax": undefined,
                    "weatherTypes": [],
                    "weatherIcon": "",
                    "weatherId": ""
                };
                forecasts.push(value);
                dayList.push(dateString);
            }
            
            // Locate the minimum temps, maximum temps, and types of weather
            $.each(forecastData, function(key, value) {
                var date = moment.utc(value.dt, "X").format(dateTimeFormat);
                var dayText = moment(date, dateTimeFormat).format("ddd");
                var tempMin = value.main.temp_min;
                var tempMax = value.main.temp_max;
                var weatherType = value.weather[0].id;
                var index = null;
                
                // Try to locate the index for the given date
                switch(date)
                {
                    case dayList[0]: index = 0; break;
                    case dayList[1]: index = 1; break;
                    case dayList[2]: index = 2; break;
                    case dayList[3]: index = 3; break;
                    case dayList[4]: index = 4; break;
                }
                
                // If an index was found, populate the object
                if(index != null) {
                    var entry = forecasts[index];
                    entry.dayText = dayText;
                    entry.tempMinArr.push(tempMin);
                    entry.tempMaxArr.push(tempMax);
                    
                    // If the weather array is empty, add a new entry
                    if(entry.weatherTypes.length == 0) {
                        entry.weatherTypes.push([weatherType, 1]);
                    } else { // Otherwise, see if the entry already exists in the array
                        var valueFound = false;
                        $.each(entry.weatherTypes, function(key, value) {
                            if(value[WEATHER_TYPE_INDEX] == weatherType) {
                                value[WEATHER_COUNT_INDEX] += 1;
                                valueFound = true;
                            }
                        });
                        
                        // If no entry was found, add a new one
                        if(!valueFound) {
                            entry.weatherTypes.push([weatherType, 1]);
                        }
                    }
                }
            });
            
            // Once the forecast array is populate, go through it again to find the 
            // temperatures and the most prevalent weather condition
            $.each(forecasts, function(key, value) {
                // Locate the minimum and maximum temperatures
                for(var i = 0; i < value.tempMinArr.length; ++i) {
                    if(value.tempMin == undefined || value.tempMinArr[i] < value.tempMin) 
                        value.tempMin = value.tempMinArr[i];
                }
                
                for(var i = 0; i < value.tempMaxArr.length; ++i) {
                    if(value.tempMax == undefined || value.tempMaxArr[i] > value.tempMax)
                        value.tempMax = value.tempMaxArr[i];          
                }
                
                // Round the value if it exists, otherwise put "N/A" in there
                if(value.tempMin != undefined)
                    value.tempMin = Math.round(value.tempMin);
                else
                    value.tempMin = "N/A";
                
                if(value.tempMax != undefined)
                    value.tempMax = Math.round(value.tempMax);
                else
                    value.tempMax = "N/A";
                
                var mostPrevalentCount = undefined;
                var mostPrevalentIndex = undefined;
                // Find the most prevalent weather condition
                for(var i = 0; i < value.weatherTypes.length; ++i) {
                    if(mostPrevalentCount == undefined || 
                        (mostPrevalentCount != undefined && value.weatherTypes[i][WEATHER_COUNT_INDEX > mostPrevalentCount])) {
                        mostPrevalentIndex = i;
                        mostPrevalentCount = value.weatherTypes[i][WEATHER_COUNT_INDEX];
                    }
                }
                
                if(mostPrevalentIndex != undefined) {
                    value.weatherId = value.weatherTypes[mostPrevalentIndex][WEATHER_TYPE_INDEX];
                    value.weatherIcon = getWeatherIcon(value.weatherId);
                } else {
                }
            })
            return forecasts;
        }
        
        var hudApp = angular.module('hudApp', []);
        
        hudApp.controller('currentWeatherController', ['$scope', '$interval', '$http',
            function($scope, $interval, $http) {
                // Set the default values
                $scope.currentWeather = {
                    icon: "2.svg",
                    temperature: "?"
                };
                
                $scope.getCurrentWeather = function() {
                    if(WEATHER_API_KEY == "" || CITY_ID == "") {
                        console.log("Weather API Key or City ID not set, exiting...");
                        return false;
                    }

                    $http.get(CURRENT_WEATHER_URL)
                        .success(function(response) {                            
                            $scope.currentWeather = {                                
                                weatherId: response.weather[0].id,
                                latitude: response.coord.lat,
                                longitude: response.coord.lon,
                                temperature: Math.round(response.main.temp),
                                icon: getWeatherIcon(response.weather[0].id)
                            }
                            
                            // TODO: retool Sunrise sunset to use angular promises too
                            /*if(SUNRISE_TIME == null || SUNSET_TIME == null)
                            getSunriseSunsetTimes(latitude, longitude);*/
                        })
                        .error(function(response) {
                            console.log("Error retreiving current weather data");
                        });
                };
                
                // Update the current, then update it every 30 minutes thereafter 
                $scope.getCurrentWeather();                
                $interval( function() { $scope.getCurrentWeather(); }, 1000 * 60 * 30);
            }
        ]);
        
        hudApp.controller('forecastController', function($scope) {            
            //getforecastWeather();            
            //setInterval('getforecastWeather()', 1000 * 60 * 60 * 12); // 12 hours
        });
        
        hudApp.controller('checklistController', function($scope) {
            
        });
        
        hudApp.controller('clockController', ['$scope', '$interval', 
            function($scope, $interval) {
                $scope.updateTime = function() {
                    $scope.clock = {
                        dateTime: moment().format('dddd, MMMM D, YYYY'),
                        hoursAndMinutes: moment().format('hh:mm'),
                        seconds: moment().format('ss')
                    };
                };
                
                // Update the time, then update it every 1 second thereafter 
                $scope.updateTime();                
                $interval( function() { $scope.updateTime(); }, 1000);
            }
        ]);

        $(document).ready(function() {
        });
        
         </script>
</body>
</html>
